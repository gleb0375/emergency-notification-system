openapi: 3.1.0
info:
  title: "Contact Service REST API"
  version: "1.0"

components:

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:

    UserRole:
      type: string
      enum: [ USER, ADMIN, SUPERADMIN ]
      description: User role

    PreferredChannel:
      type: string
      enum: [ email, sms, telegram ]
      description: Preferred notification channel

  ## -------------------- COMMON ERROR SCHEMAS --------------------
    ErrorResponse:
      type: object
      properties:
        code:
          type: integer
        message:
          type: string
      required: [ code, message ]

    ValidationErrorResponse:
      allOf:
        - $ref: '#/components/schemas/ErrorResponse'
        - type: object
          properties:
            details:
              type: array
              items:
                $ref: '#/components/schemas/ErrorDetail'
    ErrorDetail:
      type: object
      properties:
        field:
          type: string
        error:
          type: string

    ## -------------------- RABBIT SCHEMAS ---------------------------
    UserCreatedEventPayload:
      type: object
      description: Payload for routing key 'user.user_created'.
      additionalProperties: false
      required: [ accountUuid, email ]
      properties:
        accountUuid:
          type: string
          description: UUID of the account in auth-service.
          example: "2a1e9b6c-6c79-4d23-9f2a-1d0c7cc2d4f8"
        email:
          type: string
          format: email
          description: User email.
          example: "user@example.com"

    UserDeletedEventPayload:
      type: object
      description: Payload for routing key 'user.user_deleted'.
      additionalProperties: false
      required: [ accountUuid ]
      properties:
        accountUuid:
          type: string
          description: UUID of the account in auth-service.
          example: "2a1e9b6c-6c79-4d23-9f2a-1d0c7cc2d4f8"

    ## -------------------- PROFILE SCHEMAS ---------------------------

    UserProfile:
      type: object
      additionalProperties: false
      required:
        - userProfileUuid
        - authAccountUuid
        - email
        - preferredChannel
        - createdAt
        - updatedAt
      properties:
        userProfileUuid:
          type: string
          description: Public UUID of the profile
          example: "5f4d3c2b-1a09-4e8f-b7c6-1a2b3c4d5e6f"
        authAccountUuid:
          type: string
          description: UUID of the linked auth account
          example: "2a1e9b6c-6c79-4d23-9f2a-1d0c7cc2d4f8"
        surname:
          type: string
          maxLength: 100
          example: "Doe"
        name:
          type: string
          maxLength: 50
          example: "John"
        email:
          type: string
          format: email
          example: "user@example.com"
        telegramUsername:
          type: string
          maxLength: 32
          example: "john_doe"
        phoneNumber:
          type: string
          maxLength: 20
          example: "+420123456789"
        city:
          type: string
          maxLength: 100
          example: "Prague"
        countryCode:
          type: string
          pattern: "^[A-Z]{2}$"
          description: ISO 3166-1 alpha-2
          example: "CZ"
        preferredChannel:
          $ref: '#/components/schemas/PreferredChannel'
        createdAt:
          type: string
          format: date-time
          example: "2025-09-16T12:34:56Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-09-16T12:45:10Z"

    UserProfileUpdateRequest:
      type: object
      additionalProperties: false
      description: Fields that can be updated by the profile owner
      properties:
        surname:
          type: string
        name:
          type: string
        telegramUsername:
          type: string
        phoneNumber:
          type: string
        city:
          type: string
        countryCode:
          type: string
          pattern: "^[A-Z]{2}$"
          description: ISO 3166-1 alpha-2
        preferredChannel:
          $ref: '#/components/schemas/PreferredChannel'

  examples:
    MissingFields:
      summary: Missing required field
      value:
        code: 400
        message: "Missing required field."
    ValidationFailed:
      summary: Validation failed
      value:
        code: 422
        message: "Validation failed."
        details:
          - field: "countryCode"
            error: "Must be a 2-letter ISO code."
    Unauthorized:
      summary: Missing or invalid token
      value:
        code: 401
        message: "Unauthorized."
    Forbidden:
      summary: Insufficient role
      value:
        code: 403
        message: "Forbidden."
    NotFound:
      summary: Resource not found
      value:
        code: 404
        message: "Resource not found."
    GroupExists:
      summary: Group already exists
      value:
        code: 409
        message: "Group with this name already exists."
    TemplateExists:
      summary: Template already exists
      value:
        code: 409
        message: "Template with this title and channel already exists."
    InternalError:
      summary: Unexpected server error
      value:
        code: 500
        message: "Internal server error."

paths:
  /profiles/me:
    get:
      tags: [ Profiles ]
      summary: Get current user's profile
      operationId: getMyProfile
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
              examples:
                profile:
                  value:
                    userProfileUuid: "5f4d3c2b-1a09-4e8f-b7c6-1a2b3c4d5e6f"
                    authAccountUuid: "2a1e9b6c-6c79-4d23-9f2a-1d0c7cc2d4f8"
                    surname: "Doe"
                    name: "John"
                    email: "user@example.com"
                    telegramUsername: "john_doe"
                    phoneNumber: "+420123456789"
                    city: "Prague"
                    countryCode: "CZ"
                    preferredChannel: "email"
                    createdAt: "2025-09-16T12:34:56Z"
                    updatedAt: "2025-09-16T12:45:10Z"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  $ref: '#/components/examples/Unauthorized'
        '404':
          description: Profile not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  $ref: '#/components/examples/NotFound'
        '500':
          description: Internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                internal:
                  $ref: '#/components/examples/InternalError'

    patch:
      tags: [ Profiles ]
      summary: Update current user's profile
      operationId: updateMyProfile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserProfileUpdateRequest'
            examples:
              update:
                value:
                  surname: "Doe"
                  name: "John"
                  telegramUsername: "john_doe"
                  phoneNumber: "+420123456789"
                  city: "Plze≈à"
                  countryCode: "CZ"
                  preferredChannel: "telegram"
          application/merge-patch+json:
            schema:
              $ref: '#/components/schemas/UserProfileUpdateRequest'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  $ref: '#/components/examples/Unauthorized'
        '422':
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
              examples:
                validation:
                  $ref: '#/components/examples/ValidationFailed'
        '500':
          description: Internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                internal:
                  $ref: '#/components/examples/InternalError'








security:
  - bearerAuth: []