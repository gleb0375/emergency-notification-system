openapi: "3.0.3"
info:
  title: "Auth Service REST API"
  description: |
    Strict REST‑style API for authentication and account management.
  version: "1.0"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  examples:
    MissingFields:
      summary: Missing required field
      value:
        code: 400
        message: "Missing required field: email."
    InvalidCredentials:
      summary: Invalid email or password
      value:
        code: 401
        message: "Invalid email or password."
    AccountExists:
      summary: Account already exists
      value:
        code: 409
        message: "Account with this email already exists."
    ValidationFailed:
      summary: Validation failed
      value:
        code: 422
        message: "Validation failed."
        details:
          - field: "email"
            error: "Invalid email format."
    InternalError:
      summary: Unexpected server error
      value:
        code: 500
        message: "Internal server error."
    EmailNotVerified:
      summary: Email not verified
      value:
        code: 403
        message: "Email address has not been verified."

  schemas:
    ## -------------------- ACCOUNT --------------------
    AccountCreateRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        password:
          type: string
      required: [ email, password ]

    AccountCreateResponse:
      type: object
      properties:
        uuid:
          type: string
          format: uuid
          description: Public identifier of the newly created account
        message:
          type: string
          description: Human‑readable status message
        email:
          type: string
          format: email
        expiresInMinutes:
          type: integer
          description: Minutes until verification code expires
      required: [ uuid, message, email, expiresInMinutes ]


    ## -------------------- USER MANAGEMENT (ADMIN) --------------------
    UserRole:
      type: string
      enum: [ USER, ADMIN, SUPERADMIN ]
      description: User role

    UserResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        email: { type: string, format: email }
        roles:
          type: array
          items: { $ref: '#/components/schemas/UserRole' }
        verified: { type: boolean, description: Email verified flag }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
      required: [ id, email, roles, verified, createdAt ]

    UserDeleteResponse:
      type: object
      properties:
        message: { type: string, example: User successfully deleted }
        id: { type: string, format: uuid }
      required: [ message, id ]


    ## -------------------- EMAIL VERIFICATION --------------------
    SendVerificationRequest:
      type: object
      properties:
        email:
          type: string
          format: email
      required: [ email ]

    VerificationResponse:
      type: object
      properties:
        uuid:
          type: string
          format: uuid
          description: Public ID of the resource (account or email‐verification)
        message:
          type: string
        email:
          type: string
          format: email
        expiresInMinutes:
          type: integer
      required: [ uuid, message, email, expiresInMinutes ]

    ConfirmEmailRequest:
      type: object
      properties:
        email:
          type: string
          format: email
      required: [ email ]

    ConfirmEmailResponse:
      type: object
      properties:
        message:
          type: string
      required: [ message ]

    ## -------------------- SESSION --------------------
    SessionCreateRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        password:
          type: string
      required: [ email, password ]

    SessionCreateResponse:
      type: object
      properties:
        sessionUuid:
          type: string
        accessToken:
          type: string
        refreshToken:
          type: string
        userUuid:
          type: string
      required: [ sessionUuid, accessToken, refreshToken, userUuid ]

    SessionRefreshRequest:
      type: object
      properties:
        refreshToken:
          type: string
      required: [ refreshToken ]

    SessionRefreshResponse:
      type: object
      properties:
        sessionUuid:
          type: string
        accessToken:
          type: string
        refreshToken:
          type: string
        userUuid:
          type: string
      required: [ sessionUuid, accessToken, refreshToken, userUuid ]

    SessionDeleteRequest:
      type: object
      properties:
        refreshToken:
          type: string
      required: [ refreshToken ]

    SessionDeleteResponse:
      type: object
      properties:
        message:
          type: string
      required: [ message ]

    ## -------------------- COMMON ERROR SCHEMAS --------------------
    ErrorResponse:
      type: object
      properties:
        code:
          type: integer
        message:
          type: string
      required: [ code, message ]

    ValidationErrorResponse:
      allOf:
        - $ref: '#/components/schemas/ErrorResponse'
        - type: object
          properties:
            details:
              type: array
              items:
                $ref: '#/components/schemas/ErrorDetail'
    ErrorDetail:
      type: object
      properties:
        field:
          type: string
        error:
          type: string

paths:
  ## -------------------- ACCOUNTS --------------------
  /accounts:
    post:
      tags: [ Accounts ]
      summary: Register a new account (sign‑up)
      operationId: registerAccount
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AccountCreateRequest'
      responses:
        '201':
          description: Account created; verification code sent to email
          headers:
            Location:
              description: URL of created account
              schema:
                type: string
                example: /auth-accounts/7f3b2e4a-1d2c-4f5a-8b9c-0d1e2f3a4b5c
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountCreateResponse'
              examples:
                accountCreated:
                  value:
                    uuid: "7f3b2e4a-1d2c-4f5a-8b9c-0d1e2f3a4b5c"
                    message: "Verification code sent to email"
                    email: "user@example.com"
                    expiresInMinutes: 15

        '400':
          description: Missing fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missing:
                  $ref: '#/components/examples/MissingFields'

        '409':
          description: Account already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                exists:
                  $ref: '#/components/examples/AccountExists'

        '422':
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
              examples:
                validation:
                  $ref: '#/components/examples/ValidationFailed'

        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                error:
                  $ref: '#/components/examples/InternalError'

  ## -------------------------------------------------- USER MANAGEMENT (ADMIN)
  /users/{userUuid}:
    get:
      tags: [ User ]
      summary: Get user by UUID
      description:
        Returns user details (for ADMIN)
      operationId: getUser
      parameters:
        - name: userUuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
      security:
        - bearerAuth: [ ]
      x-roles: [ ADMIN ]
      responses:
        '200':
          description: User found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
              examples:
                success:
                  value:
                    id: "7d4a2c34-8d4f-4c3a-b8fb-1b3dcd7400aa"
                    email: "admin@example.com"
                    roles: [ "ADMIN" ]
                    verified: true
                    createdAt: "2025-07-19T20:15:32Z"
                    updatedAt: "2025-07-19T20:15:32Z"

        '400':
          description: Invalid UUID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidUuid:
                  value:
                    code: 400
                    message: "Malformed UUID string"

        '401':
          description: Unauthorized — missing or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  summary: Missing or invalid token
                  value:
                    code: 401
                    message: "Missing or invalid authentication token."

        '403':
          description: Forbidden — ADMIN role required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                forbidden:
                  summary: Admin role required
                  value:
                    code: 403
                    message: "Access denied. ADMIN role required."

        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  value:
                    code: 404
                    message: "User not found"

    delete:
      tags: [ User ]
      summary: Delete user by UUID
      description:
        Deletes user permanently (for ADMIN)
      operationId: deleteUser
      parameters:
        - name: userUuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
      security:
        - bearerAuth: [ ]
      x-roles: [ ADMIN ]
      responses:
        '204':
          description: User successfully deleted

        '400':
          description: Invalid UUID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidUuid:
                  value:
                    code: 400
                    message: "Malformed UUID string"

        '401':
          description: Unauthorized — missing or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  summary: Missing or invalid token
                  value:
                    code: 401
                    message: "Missing or invalid authentication token."

        '403':
          description: Forbidden — ADMIN role required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                forbidden:
                  summary: Admin role required
                  value:
                    code: 403
                    message: "Access denied. ADMIN role required."

        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  value:
                    code: 404
                    message: "User not found"

  ## -------------------- EMAIL VERIFICATIONS --------------------
  /verifications:
    post:
      tags: [ EmailVerification ]
      summary: Send or resend verification code to email
      operationId: sendVerificationCode
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendVerificationRequest'
      responses:
        '200':
          description: Verification code sent / resent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerificationResponse'
        '400':
          description: Missing email
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missing:
                  $ref: '#/components/examples/MissingFields'
        '404':
          description: Email not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  $ref: '#/components/examples/AccountExists'   # Reuse 409 example semantics
        '422':
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
              examples:
                validation:
                  $ref: '#/components/examples/ValidationFailed'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                error:
                  $ref: '#/components/examples/InternalError'

  /verifications/{token}:
    patch:
      tags: [ EmailVerification ]
      summary: Confirm email with verification code
      operationId: confirmEmail
      parameters:
        - in: path
          name: token
          schema:
            type: string
          required: true
          description: Verification code sent to email
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfirmEmailRequest'
      responses:
        '200':
          description: Email successfully verified
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmEmailResponse'
        '400':
          description: Missing email
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missing:
                  $ref: '#/components/examples/MissingFields'
        '404':
          description: Code not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  $ref: '#/components/examples/InvalidCredentials'
        '410':
          description: Code expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                expired:
                  summary: Code expired
                  value:
                    code: 410
                    message: "Verification code has expired."
        '422':
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
              examples:
                validation:
                  $ref: '#/components/examples/ValidationFailed'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                internalError:
                  $ref: '#/components/examples/InternalError'


  ## -------------------- SESSIONS --------------------
  /sessions:
    post:
      tags: [ Sessions ]
      summary: Create a new session (sign‑in)
      operationId: signIn
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionCreateRequest'
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionCreateResponse'
        '400':
          description: Missing fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missing:
                  $ref: '#/components/examples/MissingFields'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid:
                  $ref: '#/components/examples/InvalidCredentials'
        '403':
          description: Email not verified
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notVerified:
                  $ref: '#/components/examples/EmailNotVerified'
        '422':
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
              examples:
                validation:
                  $ref: '#/components/examples/ValidationFailed'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                error:
                  $ref: '#/components/examples/InternalError'

  /sessions/{sessionUuid}:
    delete:
      tags: [ Sessions ]
      summary: Invalidate session and logout
      description: Invalidate the session identified by sessionUuid
      operationId: logout
      security:
        - bearerAuth: [ ]
      parameters:
        - name: sessionUuid
          in: path
          required: true
          description: UUID of the session to invalidate
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionDeleteResponse'
        '401':
          description: Invalid or expired access token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidToken:
                  summary: Invalid or expired access token
                  value:
                    code: 401
                    message: "Invalid or expired access token."
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  summary: Session not found
                  value:
                    code: 404
                    message: "Session not found."
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                internalError:
                  $ref: '#/components/examples/InternalError'

    patch:
      tags: [ Sessions ]
      summary: Refresh an existing session
      description: Refresh the session identified by sessionUuid
      operationId: refreshSession
      parameters:
        - name: sessionUuid
          in: path
          required: true
          description: UUID of session to refresh
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionRefreshRequest'
      responses:
        '200':
          description: Session successfully refreshed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionRefreshResponse'
        '400':
          description: Missing or invalid refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingToken:
                  summary: Missing token
                  value:
                    code: 400
                    message: "Missing required field: refreshToken"
        '401':
          description: Invalid refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidToken:
                  summary: Invalid refresh token
                  value:
                    code: 401
                    message: "Invalid refresh token."
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  summary: Session not found
                  value:
                    code: 404
                    message: "Session not found."
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                internalError:
                  $ref: '#/components/examples/InternalError'
